import serial
import pynmea2
import time
from datetime import datetime, timedelta

port = "/dev/serial0"
baudrate = 9600

def idokeido():
  """
  緯度と経度を抽出します
  """
    try:
        with serial.Serial(port, baudrate, timeout=1) as ser:
            while True:
                line = ser.readline().decode('ascii', errors='replace')
                if line.startswith('$GPGGA') or line.startswith('$GPRMC'):
                    try:
                        msg = pynmea2.parse(line)
                        if hasattr(msg, 'latitude') and hasattr(msg, 'longitude'):
                            lat = msg.latitude
                            lon = msg.longitude
                            return lat, lon
                    except pynmea2.ParseError:
                        continue
    except serial.SerialException as e:
        print(f"Serial error: {e}")
        return None, None

def zikan():
    """
    日本時間を抽出します
    """
    try:
        with serial.Serial(port, baudrate, timeout=1) as ser:
            while True:
                line = ser.readline().decode('ascii', errors='replace')
                if line.startswith('$GPRMC'):
                    try:
                        msg = pynmea2.parse(line)
                        if msg.datestamp and msg.timestamp:
                            dt_utc = datetime.combine(msg.datestamp, msg.timestamp)
                            dt_jst = dt_utc + timedelta(hours=9)
                            return dt_jst.strftime('%Y-%m-%d %H:%M:%S')
                    except pynmea2.ParseError:
                        continue
    except serial.SerialException as e:
        print(f"Serial error: {e}")
        return None

def youbi(datetime_str):
    """
    曜日を抽出します
    """
    try:
        dt_object = datetime.strptime(datetime_str, '%Y-%m-%d %H:%M:%S')
        weekday = dt_object.strftime('%A')
        return weekday
